<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Multi-Sport Predictions Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a28;
            --bg-card-hover: #222235;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-blue: #3b82f6;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --border-color: rgba(255, 255, 255, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 30px rgba(99, 102, 241, 0.3);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.15);
            padding: 0.5rem 1rem;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.65rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: var(--bg-secondary);
            padding: 0.75rem 1rem;
            gap: 0.5rem;
            overflow-x: auto;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tab {
            padding: 0.6rem 1.25rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--accent-primary);
            color: white;
        }

        .live-badge {
            background: var(--accent-red);
            color: white;
            font-size: 0.6rem;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        /* Main Layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 1.5rem;
            padding: 1.5rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Sections */
        .section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn {
            background: var(--accent-primary);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--accent-secondary);
            transform: scale(1.02);
        }

        /* Games Grid */
        .games-grid {
            display: grid;
            gap: 0.75rem;
        }

        .game-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .game-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-primary);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .game-card.live {
            border-left: 3px solid var(--accent-red);
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.08), var(--bg-card));
        }

        .game-card.final {
            border-left: 3px solid var(--accent-green);
        }

        .game-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.75rem;
        }

        .status-live {
            color: var(--accent-red);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .status-live::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--accent-red);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .status-final {
            color: var(--accent-green);
            font-weight: 600;
        }

        .status-scheduled {
            color: var(--text-secondary);
        }

        .teams-container {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .team-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
        }

        .team-info {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .team-logo {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .team-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .team-record {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .team-score {
            font-size: 1.4rem;
            font-weight: 800;
        }

        .team-score.winner {
            color: var(--accent-green);
        }

        .team-score.loser {
            color: var(--accent-red);
        }

        .game-prediction {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .prediction-badge {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Picks Section */
        .picks-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
        }

        .picks-tab {
            flex: 1;
            padding: 0.5rem;
            border: none;
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .picks-tab:hover {
            background: var(--bg-card-hover);
        }

        .picks-tab.active {
            background: var(--accent-primary);
            color: white;
        }

        .picks-list {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .pick-card {
            background: var(--bg-card);
            padding: 0.875rem;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .pick-card:hover {
            border-color: var(--accent-primary);
        }

        .pick-info {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .pick-team {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .pick-type {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .pick-odds {
            font-size: 0.75rem;
            color: var(--accent-yellow);
            font-weight: 600;
        }

        .pick-confidence {
            text-align: right;
        }

        .confidence-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--accent-green);
        }

        .confidence-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .ev-badge {
            font-size: 0.7rem;
            color: var(--accent-yellow);
            font-weight: 600;
        }

        /* Parlay Section */
        .parlay-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid var(--accent-primary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .parlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .parlay-legs {
            font-weight: 700;
        }

        .parlay-odds {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--accent-green);
        }

        .parlay-picks {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            margin-bottom: 0.75rem;
        }

        .parlay-pick {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 0.4rem 0;
            border-bottom: 1px dashed var(--border-color);
        }

        .parlay-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .parlay-payout {
            color: var(--accent-green);
            font-weight: 700;
        }

        .risk-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
        }

        .risk-low {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .risk-medium {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
        }

        .risk-high {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        /* Model Stats */
        .model-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .model-stat {
            background: var(--bg-card);
            padding: 0.875rem;
            border-radius: 10px;
            text-align: center;
        }

        .model-stat-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--accent-primary);
        }

        .model-stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--bg-card);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 0.75rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .no-games {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        /* Pick Cards */
        .pick-card {
            position: relative;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .pick-card:hover {
            border-color: var(--accent-primary);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary);
            font-size: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
    </style>
</head>

<body>
    <header class="header">
        <h1>üèÜ Multi-Sport Predictions</h1>
        <div class="header-stats">
            <div class="stat-item" title="How often our AI picks the winner correctly (across all sports)">
                <div class="stat-value" id="accuracy">--</div>
                <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat-item" title="Return on Investment - How much profit you'd make betting $100 on each pick">
                <div class="stat-value" id="roi">--</div>
                <div class="stat-label">ROI</div>
            </div>
            <div class="stat-item"
                title="Number of AI models trained - each sport/bet-type has its own specialized model">
                <div class="stat-value" id="models-count">14</div>
                <div class="stat-label">Models</div>
            </div>
        </div>
    </header>

    <nav class="nav-tabs" id="sport-tabs">
        <button class="nav-tab active" data-sport="nba" data-endpoint="/basketball/nba/scoreboard">üèÄ NBA</button>
        <button class="nav-tab" data-sport="ncaa_basketball"
            data-endpoint="/basketball/mens-college-basketball/scoreboard">üèÄ NCAA</button>
        <button class="nav-tab" data-sport="nfl" data-endpoint="/football/nfl/scoreboard">üèà NFL</button>
        <button class="nav-tab" data-sport="ncaa_football" data-endpoint="/football/college-football/scoreboard">üèà
            CFB</button>
        <button class="nav-tab" data-sport="nhl" data-endpoint="/hockey/nhl/scoreboard">üèí NHL</button>
        <button class="nav-tab" data-sport="mlb" data-endpoint="/baseball/mlb/scoreboard">‚öæ MLB</button>
        <button class="nav-tab" data-sport="tennis" data-endpoint="/tennis/atp/scoreboard">üéæ Tennis</button>
        <button class="nav-tab" data-sport="soccer" data-endpoint="/soccer/eng.1/scoreboard">‚öΩ Soccer</button>
    </nav>

    <main class="main-content">
        <section class="section">
            <div class="section-header">
                <h2 class="section-title" id="section-title">üèÄ NBA Games Today</h2>
                <button class="btn" onclick="refreshGames()">üîÑ Refresh</button>
            </div>
            <div class="games-grid" id="games-container">
                <div class="loading">
                    <div class="loading-spinner"></div>Loading games...
                </div>
            </div>
        </section>

        <aside class="sidebar">
            <!-- Best Picks -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">üéØ Best Picks</h3>
                </div>
                <div class="picks-tabs">
                    <button class="picks-tab active" data-type="moneyline"
                        title="Pick the winner - simplest bet type">Moneyline</button>
                    <button class="picks-tab" data-type="spread"
                        title="Predict if a team wins by enough points (or loses by less)">Spread</button>
                    <button class="picks-tab" data-type="total"
                        title="Predict if combined score goes Over or Under a number">O/U</button>
                    <button class="picks-tab" data-type="contracts"
                        title="Trade prediction contracts like stocks - advanced">üìà Contracts</button>
                    <button class="picks-tab" data-type="history" title="View past predictions and their results">üìú
                        History</button>
                </div>
                <div id="bet-type-explainer"
                    style="font-size:0.7rem;color:var(--text-secondary);padding:0.5rem 0;border-bottom:1px dashed var(--border-color);margin-bottom:0.5rem">
                </div>
                <div class="picks-list" id="picks-list"></div>
            </div>

            <!-- Prediction Market Guide -->
            <div class="section" id="contracts-guide" style="display:none">
                <div class="section-header">
                    <h3 class="section-title">üìà Prediction Market Guide</h3>
                </div>
                <div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.6">
                    <p style="margin-bottom:0.75rem"><strong style="color:var(--accent-green)">How Contracts
                            Work:</strong></p>
                    <p style="margin-bottom:0.5rem">‚Ä¢ Contracts priced <strong>$0.01 - $0.99</strong> (price =
                        probability)</p>
                    <p style="margin-bottom:0.5rem">‚Ä¢ If you're <strong>RIGHT</strong>: each contract pays <strong
                            style="color:var(--accent-green)">$1.00</strong></p>
                    <p style="margin-bottom:0.75rem">‚Ä¢ If you're <strong>WRONG</strong>: contract worth <strong
                            style="color:var(--accent-red)">$0.00</strong></p>

                    <p style="margin-bottom:0.5rem"><strong style="color:var(--accent-yellow)">üìä Example
                            Trade:</strong></p>
                    <div
                        style="background:rgba(255,255,255,0.03);padding:0.5rem;border-radius:6px;margin-bottom:0.75rem;font-family:monospace;font-size:0.7rem">
                        <p>Lakers to win vs Celtics</p>
                        <p>Market price: <strong style="color:var(--accent-yellow)">$0.62</strong> (62% implied)</p>
                        <p>Our AI says: <strong style="color:var(--accent-green)">68%</strong> ‚Üê Edge!</p>
                        <p style="border-top:1px dashed var(--border-color);margin-top:0.3rem;padding-top:0.3rem">
                            Buy: <strong>32 contracts √ó $0.62 = $20.00</strong></p>
                        <p style="color:var(--accent-green)">If Lakers win: 32 √ó $1 = <strong>$32.00</strong> (+$12
                            profit)</p>
                        <p style="color:var(--accent-red)">If Lakers lose: <strong>$0.00</strong> (-$20 loss)</p>
                    </div>

                    <p style="margin-bottom:0.5rem"><strong style="color:var(--accent-primary)">üéØ Where to
                            Trade:</strong></p>
                    <p style="margin-bottom:0.3rem">‚Ä¢ <strong>Polymarket</strong> - Crypto, no US restrictions</p>
                    <p style="margin-bottom:0.3rem">‚Ä¢ <strong>Kalshi</strong> - US legal, regulated</p>
                    <p style="margin-bottom:0.75rem">‚Ä¢ <strong>PredictIt</strong> - US legal, $850 max per market</p>

                    <p
                        style="padding:0.5rem;background:rgba(99,102,241,0.1);border-radius:8px;border-left:3px solid var(--accent-primary)">
                        üí° <strong>Pro Tip:</strong> Only bet when AI confidence > market price by 5%+ ‚Äî that's your
                        edge!
                    </p>
                </div>
            </div>

            <!-- Parlays -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title" title="Parlays combine multiple picks - all must win for bigger payouts">
                        üé∞ Parlay Builder</h3>
                </div>
                <div
                    style="font-size:0.65rem;color:var(--text-secondary);padding:0.25rem 0 0.5rem;border-bottom:1px dashed var(--border-color);margin-bottom:0.5rem">
                    üí° <strong>Parlay</strong> = Combine picks for bigger payouts. ALL must win! Open DraftKings,
                    FanDuel, or BetMGM ‚Üí add multiple picks to your betslip ‚Üí select "Parlay" option.
                </div>
                <div id="parlays-container"></div>
            </div>

            <!-- Model Performance -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">üìä Model Stats</h3>
                </div>
                <div class="model-stats" id="model-stats">
                    <div class="model-stat">
                        <div class="model-stat-value" id="stat-accuracy">--</div>
                        <div class="model-stat-label">Avg Accuracy</div>
                    </div>
                    <div class="model-stat">
                        <div class="model-stat-value" id="stat-roi">--</div>
                        <div class="model-stat-label">Est. ROI</div>
                    </div>
                    <div class="model-stat">
                        <div class="model-stat-value" id="stat-sports">6</div>
                        <div class="model-stat-label">Sports</div>
                    </div>
                    <div class="model-stat">
                        <div class="model-stat-value" id="stat-models">14</div>
                        <div class="model-stat-label">Models</div>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <footer class="footer">
        Last updated: <span id="last-updated">--</span> | V6 Models trained: 12/23/2025 |
        <a href="#" style="color: var(--accent-primary);">View Training Results</a>
    </footer>

    <script>
        const ESPN_BASE = 'https://site.api.espn.com/apis/site/v2/sports';
        let currentSport = 'nba';
        let currentEndpoint = '/basketball/nba/scoreboard';
        let currentPickType = 'moneyline';

        // Model accuracy data - BEST MODELS per sport + bet type (Dec 2025)
        // Uses V6 + V7 advanced models where they beat baseline
        // V7: MLB ML 58.1%, NHL spread 67.4%
        const modelData = {
            nba: { moneyline: 0.65, spread: 0.73, overunder: 0.62, contracts: 0.65 },  // V6 best
            nfl: { moneyline: 0.65, spread: 0.69, overunder: 0.56, contracts: 0.65 },  // V6 spread specialized
            nhl: { moneyline: 0.72, spread: 0.67, overunder: 0.60, contracts: 0.72 },  // V7 spread 67.4%
            mlb: { moneyline: 0.58, spread: 0.62, overunder: 0.58, contracts: 0.58 },  // V7 ML 58.1%
            ncaa_basketball: { moneyline: 0.65, contracts: 0.65 },
            soccer: { moneyline: 0.67, spread: 0.75, overunder: 0.62, contracts: 0.67 },  // V6 ML specialized
            tennis: { moneyline: 0.63, contracts: 0.63 }
        };

        // Contracts Brier scores (lower = better calibration)
        const contractsBrier = {
            nba: 0.2139,
            nfl: 0.2479,
            nhl: 0.2491,
            mlb: 0.2471,
            soccer: 0.2019
        };

        const sportNames = {
            'nba': 'üèÄ NBA', 'ncaa_basketball': 'üèÄ NCAA Basketball', 'nfl': 'üèà NFL',
            'ncaa_football': 'üèà College Football', 'nhl': 'üèí NHL', 'mlb': '‚öæ MLB',
            'tennis': 'üéæ Tennis', 'soccer': '‚öΩ Soccer (All Leagues)'
        };

        // Soccer leagues to fetch
        const soccerLeagues = [
            { id: 'eng.1', name: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier League' },
            { id: 'esp.1', name: 'üá™üá∏ La Liga' },
            { id: 'ger.1', name: 'üá©üá™ Bundesliga' },
            { id: 'ita.1', name: 'üáÆüáπ Serie A' },
            { id: 'fra.1', name: 'üá´üá∑ Ligue 1' },
            { id: 'uefa.champions', name: 'üèÜ Champions League' },
            { id: 'usa.1', name: 'üá∫üá∏ MLS' },
            { id: 'por.1', name: 'üáµüáπ Primeira Liga' },
            { id: 'ned.1', name: 'üá≥üá± Eredivisie' },
            { id: 'mex.1', name: 'üá≤üáΩ Liga MX' }
        ];

        // Cache for predictions - keeps them consistent
        const predictionCache = {};

        // Real predictions from trained models
        let realPredictions = {};
        let predictionsLoaded = false;

        // Load real predictions from JSON
        async function loadRealPredictions() {
            try {
                const response = await fetch('data/predictions.json');
                const data = await response.json();
                realPredictions = data.predictions || {};
                predictionsLoaded = true;
                console.log('‚úÖ Loaded real predictions:', Object.keys(realPredictions).map(k => `${k}: ${realPredictions[k].length}`).join(', '));
                return true;
            } catch (e) {
                console.warn('‚ö†Ô∏è Could not load predictions.json, using fallback:', e.message);
                predictionsLoaded = false;
                return false;
            }
        }

        // Get real prediction for a game (from trained models)
        function getRealPrediction(gameId, sport) {
            if (!predictionsLoaded || !realPredictions[sport]) {
                return null;
            }
            return realPredictions[sport].find(p => p.game_id === gameId);
        }

        // =========================
        // NFL BOXSCORE STATS SYSTEM
        // =========================
        const boxscoreCache = {};

        // Fetch boxscore stats for NFL games
        async function fetchNFLBoxscore(eventId) {
            if (boxscoreCache[eventId]) {
                return boxscoreCache[eventId];
            }
            try {
                const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${eventId}`);
                const data = await response.json();
                const boxscore = data.boxscore || {};
                const teams = boxscore.teams || [];

                const stats = {};
                teams.forEach(t => {
                    const abbr = t.team?.abbreviation;
                    if (abbr) {
                        stats[abbr] = {};
                        (t.statistics || []).forEach(s => {
                            stats[abbr][s.name] = s.displayValue;
                        });
                    }
                });

                boxscoreCache[eventId] = stats;
                return stats;
            } catch (e) {
                console.warn('Could not fetch boxscore:', e);
                return null;
            }
        }

        // Load boxscores for all NFL games on page
        async function loadNFLBoxscores(events) {
            if (currentSport !== 'nfl') return;

            const finishedGames = events.filter(e =>
                e.status?.type?.name?.includes('FINAL') ||
                e.status?.type?.name?.includes('IN_PROGRESS')
            );

            for (const event of finishedGames) {
                const stats = await fetchNFLBoxscore(event.id);
                if (stats) {
                    updateGameCardWithStats(event.id, stats);
                }
            }
        }

        // Update a game card with fetched stats
        function updateGameCardWithStats(eventId, stats) {
            const card = document.querySelector(`[data-event-id="${eventId}"]`);
            if (!card) return;

            const statsContainer = card.querySelector('.nfl-stats-placeholder');
            if (!statsContainer) return;

            const teams = Object.keys(stats);
            if (teams.length < 2) return;

            const away = teams[0];
            const home = teams[1];
            const awayStats = stats[away];
            const homeStats = stats[home];

            // Determine winner from the card's score elements
            const scores = card.querySelectorAll('.team-score');
            const awayWins = scores[0]?.classList.contains('winner');
            const homeWins = scores[1]?.classList.contains('winner');

            // Update the placeholder with stats - matching NBA format
            // Reset styles and add content (header is already in parent HTML)
            statsContainer.style.textAlign = 'left';
            statsContainer.style.fontStyle = 'normal';
            statsContainer.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 80px 80px;gap:0.5rem;row-gap:0.4rem">
            <span style="color:var(--text-secondary)">üèà Total Yds (Offense)</span>
            <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${awayStats.totalYards || '-'}</span>
            <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${homeStats.totalYards || '-'}</span>
            
            <span style="color:var(--text-secondary)">üèÉ Rush Yds (Rushing)</span>
            <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${awayStats.rushingYards || '-'}</span>
            <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${homeStats.rushingYards || '-'}</span>
            
            <span style="color:var(--text-secondary)">üîÑ 1st Dwns (First Downs)</span>
            <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${awayStats.firstDowns || '-'}</span>
            <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${homeStats.firstDowns || '-'}</span>
            
            <span style="color:var(--text-secondary)">‚ùå TO (Turnovers)</span>
            <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${awayStats.turnovers || '-'}</span>
            <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${homeStats.turnovers || '-'}</span>
        </div>
    `;
        }
        // Seeded random number generator (deterministic based on seed)
        function seededRandom(seed) {
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                const char = seed.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            const x = Math.sin(hash) * 10000;
            return x - Math.floor(x);
        }

        // =========================
        // PREDICTION HISTORY SYSTEM
        // =========================

        // Load history from localStorage
        function loadHistory() {
            try {
                const saved = localStorage.getItem('prediction_history');
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                return [];
            }
        }

        // Save history to localStorage
        function saveHistory(history) {
            try {
                localStorage.setItem('prediction_history', JSON.stringify(history));
            } catch (e) {
                console.error('Failed to save history:', e);
            }
        }

        // Add a prediction to history
        function addPrediction(prediction) {
            const history = loadHistory();
            // Check if already exists
            const exists = history.find(h => h.gameId === prediction.gameId && h.betType === prediction.betType);
            if (!exists) {
                history.push({
                    ...prediction,
                    timestamp: new Date().toISOString(),
                    result: 'pending'
                });
                saveHistory(history);
            }
        }

        // Update prediction result (win/loss)
        function updatePredictionResult(gameId, betType, result) {
            const history = loadHistory();
            const pred = history.find(h => h.gameId === gameId && h.betType === betType);
            if (pred && pred.result === 'pending') {
                pred.result = result; // 'win', 'loss', or 'push'
                pred.resolvedAt = new Date().toISOString();
                saveHistory(history);
            }
        }

        // Calculate stats from history
        function calculateStats() {
            const history = loadHistory();
            const resolved = history.filter(h => h.result !== 'pending');
            const wins = resolved.filter(h => h.result === 'win').length;
            const losses = resolved.filter(h => h.result === 'loss').length;
            const pushes = resolved.filter(h => h.result === 'push').length;
            const total = wins + losses;

            const statsBySport = {};
            const statsByType = {};

            resolved.forEach(h => {
                // By sport
                if (!statsBySport[h.sport]) statsBySport[h.sport] = { wins: 0, losses: 0 };
                if (h.result === 'win') statsBySport[h.sport].wins++;
                else if (h.result === 'loss') statsBySport[h.sport].losses++;

                // By type
                if (!statsByType[h.betType]) statsByType[h.betType] = { wins: 0, losses: 0 };
                if (h.result === 'win') statsByType[h.betType].wins++;
                else if (h.result === 'loss') statsByType[h.betType].losses++;
            });

            return {
                total: history.length,
                pending: history.filter(h => h.result === 'pending').length,
                wins,
                losses,
                pushes,
                winRate: total > 0 ? (wins / total * 100).toFixed(1) : 0,
                statsBySport,
                statsByType
            };
        }

        // Load prediction history from CSV file
        async function loadHistoryFromCSV() {
            try {
                const response = await fetch('data/prediction_history.csv');
                const csvText = await response.text();

                // Parse CSV
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',');

                const predictions = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const obj = {};
                    headers.forEach((h, i) => {
                        obj[h.trim()] = values[i] ? values[i].trim() : '';
                    });
                    obj.confidence = parseFloat(obj.confidence) || 0;
                    return obj;
                }).reverse(); // Most recent first

                // Calculate stats
                const resolved = predictions.filter(p => ['win', 'loss', 'push'].includes(p.result));
                const wins = resolved.filter(p => p.result === 'win').length;
                const losses = resolved.filter(p => p.result === 'loss').length;
                const pushes = resolved.filter(p => p.result === 'push').length;
                const pending = predictions.filter(p => p.result === 'pending').length;
                const total = wins + losses;

                // Stats by sport
                const bySport = {};
                resolved.forEach(p => {
                    if (!bySport[p.sport]) bySport[p.sport] = { wins: 0, losses: 0 };
                    if (p.result === 'win') bySport[p.sport].wins++;
                    else if (p.result === 'loss') bySport[p.sport].losses++;
                });
                Object.keys(bySport).forEach(k => {
                    const s = bySport[k];
                    s.winRate = (s.wins + s.losses) > 0 ? ((s.wins / (s.wins + s.losses)) * 100).toFixed(1) : 0;
                });

                // Stats by bet type
                const byType = {};
                resolved.forEach(p => {
                    if (!byType[p.bet_type]) byType[p.bet_type] = { wins: 0, losses: 0 };
                    if (p.result === 'win') byType[p.bet_type].wins++;
                    else if (p.result === 'loss') byType[p.bet_type].losses++;
                });
                Object.keys(byType).forEach(k => {
                    const s = byType[k];
                    s.winRate = (s.wins + s.losses) > 0 ? ((s.wins / (s.wins + s.losses)) * 100).toFixed(1) : 0;
                });

                return {
                    predictions,
                    stats: {
                        total: predictions.length,
                        wins,
                        losses,
                        pushes,
                        pending,
                        winRate: total > 0 ? ((wins / total) * 100).toFixed(1) : 0,
                        bySport,
                        byType
                    }
                };
            } catch (e) {
                console.error('Error loading history:', e);
                return {
                    predictions: [],
                    stats: { total: 0, wins: 0, losses: 0, pushes: 0, pending: 0, winRate: 0, bySport: {}, byType: {} }
                };
            }
        }

        // Export history to CSV (includes both tracked and historical)
        async function exportHistoryCSV() {
            const localHistory = loadHistory();
            let csvData = { predictions: [] };

            try {
                csvData = await loadHistoryFromCSV();
            } catch (e) {
                console.log('No CSV history found, exporting localStorage only');
            }

            // Convert localStorage format
            const localFormatted = localHistory.map(h => ({
                date: h.timestamp ? new Date(h.timestamp).toISOString().split('T')[0] : '',
                sport: h.sport,
                bet_type: h.betType,
                pick: h.pick,
                confidence: h.confidence,
                odds: h.odds || '-',
                game_id: h.gameId,
                result: h.result,
                actual_score: '',
                resolved_date: h.resolvedAt ? new Date(h.resolvedAt).toISOString().split('T')[0] : '',
                source: 'tracked'
            }));

            // Add source to CSV predictions
            const csvFormatted = csvData.predictions.map(p => ({
                ...p,
                source: 'historical'
            }));

            // Merge all
            const allPredictions = [...localFormatted, ...csvFormatted];

            if (allPredictions.length === 0) {
                alert('No predictions to export');
                return;
            }

            // Sort by date
            allPredictions.sort((a, b) => {
                const dateA = new Date(a.date || 0);
                const dateB = new Date(b.date || 0);
                return dateB - dateA;
            });

            const headers = ['Date', 'Sport', 'Bet Type', 'Pick', 'Confidence', 'Odds', 'Game ID', 'Result', 'Score', 'Resolved', 'Source'];
            const rows = allPredictions.map(h => [
                h.date,
                h.sport,
                h.bet_type,
                `"${(h.pick || '').replace(/"/g, '""')}"`, // Escape quotes in CSV
                ((h.confidence || 0) * 100).toFixed(1) + '%',
                h.odds || '-',
                h.game_id || '',
                h.result,
                h.actual_score || '',
                h.resolved_date || '',
                h.source
            ]);

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `predictions_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Clear all history
        function clearHistory() {
            if (confirm('Are you sure you want to clear all prediction history?')) {
                localStorage.removeItem('prediction_history');
                updatePicks();
            }
        }

        // Check finished games and update results
        function checkFinishedGames(events) {
            const history = loadHistory();
            const pending = history.filter(h => h.result === 'pending');

            events.forEach(event => {
                const status = event.status?.type?.name || '';
                if (!status.includes('FINAL')) return;

                const comp = event.competitions?.[0] || {};
                const competitors = comp.competitors || [];
                const home = competitors.find(c => c.homeAway === 'home');
                const away = competitors.find(c => c.homeAway === 'away');

                if (!home || !away) return;

                const homeScore = parseInt(home.score) || 0;
                const awayScore = parseInt(away.score) || 0;
                const totalPoints = homeScore + awayScore;
                const margin = homeScore - awayScore; // Positive = home won by margin
                const homeWon = homeScore > awayScore;

                const homeName = home.team?.abbreviation || home.team?.displayName || '';
                const awayName = away.team?.abbreviation || away.team?.displayName || '';

                // Check if we have a pending prediction for this game
                pending.forEach(pred => {
                    if (pred.gameId !== event.id) return;

                    let result = 'loss';

                    switch (pred.betType) {
                        case 'moneyline':
                            // Check if predicted team won
                            const predictedHome = pred.pick.includes(homeName);
                            result = (predictedHome === homeWon) ? 'win' : 'loss';
                            if (homeScore === awayScore) result = 'push';
                            break;

                        case 'spread':
                            // Parse spread from pick (e.g., "Lakers -4.5" or "Celtics +3.5")
                            const spreadMatch = pred.pick.match(/([+-]?\d+\.?\d*)/);
                            if (spreadMatch) {
                                const spreadLine = parseFloat(spreadMatch[1]);
                                const pickIsHome = pred.pick.includes(homeName);

                                // Calculate if bet covers
                                let adjustedMargin;
                                if (pickIsHome) {
                                    // Home team covers if: homeScore - awayScore > -spreadLine
                                    adjustedMargin = margin + spreadLine;
                                } else {
                                    // Away team covers if: awayScore - homeScore > -spreadLine
                                    adjustedMargin = -margin + spreadLine;
                                }

                                if (adjustedMargin > 0) result = 'win';
                                else if (adjustedMargin === 0) result = 'push';
                                else result = 'loss';
                            }
                            break;

                        case 'total':
                        case 'overunder':
                            // Parse total from pick (e.g., "Over 215.5" or "Under 220")
                            const totalMatch = pred.pick.match(/(\d+\.?\d*)/);
                            const isOver = pred.pick.toLowerCase().includes('over');

                            if (totalMatch) {
                                const line = parseFloat(totalMatch[1]);
                                if (totalPoints === line) {
                                    result = 'push';
                                } else if (isOver) {
                                    result = totalPoints > line ? 'win' : 'loss';
                                } else {
                                    result = totalPoints < line ? 'win' : 'loss';
                                }
                            }
                            break;

                        case 'contracts':
                            // Contracts are like moneyline - check if selected team won
                            // Pick format: "Team YES" or "Team NO"
                            const isYes = pred.pick.toLowerCase().includes('yes');
                            const contractTeam = pred.pick.replace(/\s*(YES|NO)\s*/i, '').trim();
                            const teamWon = contractTeam.includes(homeName) ? homeWon : !homeWon;

                            if (isYes) {
                                result = teamWon ? 'win' : 'loss';
                            } else {
                                result = !teamWon ? 'win' : 'loss';
                            }
                            break;
                    }

                    updatePredictionResult(pred.gameId, pred.betType, result);
                });
            });

            // Also check parlay predictions
            const parlayPending = pending.filter(h => h.betType === 'parlay' && h.parlayLegs);
            parlayPending.forEach(parlay => {
                // Check each leg of the parlay
                let allLegsResolved = true;
                let allLegsWon = true;
                let legsWon = 0;
                let totalLegs = parlay.parlayLegs.length;

                parlay.parlayLegs.forEach(leg => {
                    // Find the game result for this leg
                    const matchingEvent = events.find(e => e.id === leg.gameId);
                    if (!matchingEvent) {
                        allLegsResolved = false;
                        return;
                    }

                    const status = matchingEvent.status?.type?.name || '';
                    if (!status.includes('FINAL')) {
                        allLegsResolved = false;
                        return;
                    }

                    const comp = matchingEvent.competitions?.[0] || {};
                    const competitors = comp.competitors || [];
                    const home = competitors.find(c => c.homeAway === 'home');
                    const away = competitors.find(c => c.homeAway === 'away');

                    if (!home || !away) {
                        allLegsResolved = false;
                        return;
                    }

                    const homeScore = parseInt(home.score) || 0;
                    const awayScore = parseInt(away.score) || 0;
                    const homeWon = homeScore > awayScore;
                    const homeName = home.team?.abbreviation || home.team?.displayName || '';

                    // Check if the predicted team won
                    const predictedHome = leg.team.includes(homeName.substring(0, 3)) || leg.team.includes(homeName);
                    const legWon = (predictedHome === homeWon);

                    if (legWon) legsWon++;
                    else allLegsWon = false;
                });

                if (allLegsResolved) {
                    const result = allLegsWon ? 'win' : 'loss';
                    updatePredictionResult(parlay.gameId, 'parlay', result);
                }
            });
        }

        // Get or create prediction for a game (consistent)
        function getPrediction(gameId, homeName, awayName, baseAcc) {
            if (predictionCache[gameId]) {
                return predictionCache[gameId];
            }

            // Use game ID as seed for consistent randomness
            const rand1 = seededRandom(gameId + '_pick');
            const rand2 = seededRandom(gameId + '_conf');

            const predictHome = rand1 > 0.45;
            const predTeam = predictHome ? homeName : awayName;
            const predConfidence = Math.min(baseAcc + (rand2 * 0.1 - 0.05), 0.85);

            const prediction = {
                team: predTeam,
                confidence: predConfidence,
                pickHome: predictHome
            };

            predictionCache[gameId] = prediction;
            return prediction;
        }

        // Tab switching
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentSport = tab.dataset.sport;
                currentEndpoint = tab.dataset.endpoint;
                document.getElementById('section-title').textContent = sportNames[currentSport] + ' Games Today';
                loadGames();
                updatePicks();
            });
        });

        // Picks tabs
        const betExplainers = {
            moneyline: "üí° <strong>Moneyline</strong> = Pick who wins the game. Simplest bet! Open DraftKings, FanDuel, or BetMGM ‚Üí find the game ‚Üí tap the team name to bet them to win.",
            spread: "üí° <strong>Spread</strong> = Pick if a team wins by enough points. Example: \"Lakers -5\" means Lakers must win by 6+ points. Open DraftKings, FanDuel, or BetMGM ‚Üí tap the spread number next to the team.",
            total: "üí° <strong>Over/Under</strong> = Predict if total combined score goes OVER or UNDER a number. Open DraftKings, FanDuel, or BetMGM ‚Üí find the O/U line ‚Üí tap OVER or UNDER.",
            contracts: "üí° <strong>Contracts</strong> = Trade predictions like stocks! Example: Lakers win priced at 65¬¢. Buy $20 worth (30 shares). If they win ‚Üí you get $30 back (+$10 profit!). Open Polymarket, Kalshi, or PredictIt ‚Üí search the game ‚Üí buy YES or NO.",
            history: "üìú Your tracked predictions and their results. See how well you're doing over time!"
        };

        function updateExplainer() {
            const explainer = document.getElementById('bet-type-explainer');
            if (explainer) {
                explainer.innerHTML = betExplainers[currentPickType] || '';
            }
        }

        document.querySelectorAll('.picks-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.picks-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentPickType = tab.dataset.type;
                updateExplainer();
                updatePicks();
            });
        });

        // Set initial explainer
        updateExplainer();

        async function loadGames() {
            const container = document.getElementById('games-container');
            container.innerHTML = `<div class="loading"><div class="loading-spinner"></div>Loading ${sportNames[currentSport]} games...</div>`;

            try {
                let events = [];

                // For soccer, fetch from multiple leagues
                if (currentSport === 'soccer') {
                    const allGames = await Promise.allSettled(
                        soccerLeagues.map(async (league) => {
                            try {
                                const response = await fetch(`${ESPN_BASE}/soccer/${league.id}/scoreboard`);
                                const data = await response.json();
                                // Add league info to each event
                                return (data.events || []).map(e => ({ ...e, leagueName: league.name, leagueId: league.id }));
                            } catch (e) {
                                return [];
                            }
                        })
                    );
                    // Combine all successful results
                    events = allGames
                        .filter(r => r.status === 'fulfilled')
                        .flatMap(r => r.value);

                    // Sort by: live games first, then by date
                    events.sort((a, b) => {
                        const aLive = a.status?.type?.name?.includes('IN_PROGRESS');
                        const bLive = b.status?.type?.name?.includes('IN_PROGRESS');
                        if (aLive && !bLive) return -1;
                        if (!aLive && bLive) return 1;
                        return new Date(a.date) - new Date(b.date);
                    });
                } else {
                    // Standard single-league fetch
                    const response = await fetch(`${ESPN_BASE}${currentEndpoint}`);
                    const data = await response.json();
                    events = data.events || [];
                }

                // Check for finished games and resolve pending predictions
                checkFinishedGames(events);

                displayGames(events);
                updateLiveCount(events);
                generateParlays(events);

                // Fetch detailed boxscore stats for NFL games
                if (currentSport === 'nfl') {
                    loadNFLBoxscores(events);
                }
            } catch (error) {
                container.innerHTML = `<div class="no-games">Error loading games: ${error.message}</div>`;
            }

            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        }

        function displayGames(events) {
            const container = document.getElementById('games-container');

            if (events.length === 0) {
                container.innerHTML = '<div class="no-games">No games scheduled today</div>';
                return;
            }

            const sportAccuracy = modelData[currentSport] || { moneyline: 0.55 };

            container.innerHTML = events.map(event => {
                const comp = event.competitions?.[0] || {};
                const competitors = comp.competitors || [];

                if (competitors.length < 2) return '';

                const home = competitors.find(c => c.homeAway === 'home') || competitors[0];
                const away = competitors.find(c => c.homeAway === 'away') || competitors[1];

                const status = event.status?.type?.name || '';
                const isLive = status.includes('IN_PROGRESS');
                const isFinal = status.includes('FINAL');

                const homeScore = parseInt(home.score) || 0;
                const awayScore = parseInt(away.score) || 0;
                const homeWins = isFinal && homeScore > awayScore;
                const awayWins = isFinal && awayScore > homeScore;

                const period = event.status?.period || '';
                const clock = event.status?.displayClock || '';
                const broadcast = comp.broadcasts?.[0]?.names?.[0] || '';

                const gameTime = new Date(event.date);
                const now = new Date();
                const isToday = gameTime.toDateString() === now.toDateString();
                const isTomorrow = gameTime.toDateString() === new Date(now.getTime() + 86400000).toDateString();

                // Full date formatting
                const timeStr = gameTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const fullDateStr = gameTime.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                // Smart date display
                let dateDisplay;
                if (isToday) {
                    dateDisplay = `Today ${timeStr}`;
                } else if (isTomorrow) {
                    dateDisplay = `Tomorrow ${timeStr}`;
                } else {
                    dateDisplay = `${fullDateStr} ${timeStr}`;
                }

                // Try to get REAL prediction from trained models
                const gameId = event.id || `${home.team?.id}_${away.team?.id}`;
                const realPred = getRealPrediction(gameId, currentSport);

                let predTeam, predConfidence, prediction, isRealPrediction;

                if (realPred && realPred.predictions) {
                    // USE REAL PREDICTION FROM TRAINED MODEL (new format with all bet types)
                    const mlPred = realPred.predictions.moneyline;
                    predTeam = mlPred.pick;
                    predConfidence = mlPred.confidence;
                    prediction = {
                        team: mlPred.pick,
                        confidence: mlPred.confidence,
                        pickHome: mlPred.pick_home,
                        // Include other bet types for display
                        spread: realPred.predictions.spread,
                        total: realPred.predictions.total
                    };
                    isRealPrediction = true;
                } else if (realPred) {
                    // OLD format (backwards compatibility)
                    predTeam = realPred.pick;
                    predConfidence = realPred.confidence;
                    prediction = {
                        team: realPred.pick,
                        confidence: realPred.confidence,
                        pickHome: realPred.pick_home
                    };
                    isRealPrediction = true;
                } else {
                    // FALLBACK: Generate consistent prediction using game ID
                    const baseAcc = sportAccuracy.moneyline || 0.55;
                    prediction = getPrediction(
                        gameId,
                        home.team?.abbreviation || 'HOME',
                        away.team?.abbreviation || 'AWAY',
                        baseAcc
                    );
                    predTeam = prediction.team;
                    predConfidence = prediction.confidence;
                    isRealPrediction = false;
                }

                let statusHtml = '';
                if (isLive) {
                    statusHtml = `<span class="status-live">LIVE ‚Ä¢ Q${period} ${clock}</span>`;
                } else if (isFinal) {
                    statusHtml = `<span class="status-final">‚úì FINAL</span>`;
                } else {
                    statusHtml = `<span class="status-scheduled">üìÖ ${dateDisplay}</span>`;
                }

                // Extract additional data from ESPN API
                const venue = comp.venue?.fullName || '';
                const odds = comp.odds?.[0] || {};
                const spread = odds.details || '';
                const overUnder = odds.overUnder ? `O/U ${odds.overUnder}` : '';

                // Team stats (live games)
                const homeStats = home.statistics || [];
                const awayStats = away.statistics || [];
                const getStatValue = (stats, name) => stats.find(s => s.name === name)?.displayValue || '';

                // Leaders
                const homeLeaders = home.leaders?.[0]?.leaders?.[0] || {};
                const awayLeaders = away.leaders?.[0]?.leaders?.[0] || {};

                // Line scores (quarters/periods)
                const homeLineScores = home.linescores || [];
                const awayLineScores = away.linescores || [];

                return `
                    <div class="game-card ${isLive ? 'live' : ''} ${isFinal ? 'final' : ''}" data-event-id="${event.id}">
                        <div class="game-status">
                            ${statusHtml}
                            <span style="font-size:0.7rem;color:var(--text-secondary)">${event.leagueName ? event.leagueName + ' ‚Ä¢ ' : ''}${broadcast ? 'üì∫ ' + broadcast : ''}</span>
                        </div>
                        
                        <!-- Venue & Odds Row -->
                        ${venue || spread ? `
                        <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:var(--text-secondary);margin-bottom:0.5rem;padding:0.25rem 0;border-bottom:1px dashed var(--border-color)">
                            <span>üèüÔ∏è ${venue}</span>
                            <span style="color:var(--accent-yellow)">${spread} ${overUnder}</span>
                        </div>
                        ` : ''}
                        
                        <div class="teams-container">
                            <div class="team-row">
                                <div class="team-info">
                                    <div class="team-logo">${away.team?.abbreviation?.substring(0, 3) || '??'}</div>
                                    <div>
                                        <div class="team-name">${away.team?.shortDisplayName || away.team?.displayName || 'Away'}</div>
                                        <div class="team-record" title="Season Record: Wins - Losses">${away.records?.[0]?.summary || ''}</div>
                                    </div>
                                </div>
                                <div style="display:flex;align-items:center;gap:0.5rem">
                                    ${awayLineScores.length > 0 ? `
                                    <div style="display:flex;gap:0.25rem;font-size:0.65rem;color:var(--text-secondary)" title="Quarter/Period Scores: Points scored in Q1, Q2, Q3, Q4">
                                        ${awayLineScores.map((ls, i) => `<span style="background:var(--bg-card);padding:0.1rem 0.25rem;border-radius:3px" title="Q${i + 1}: ${ls.value || 0} pts">${ls.value || 0}</span>`).join('')}
                                    </div>
                                    ` : ''}
                                    <div class="team-score ${awayWins ? 'winner' : ''} ${isFinal && homeWins ? 'loser' : ''}" title="Final Score">${isLive || isFinal ? awayScore : ''}</div>
                                </div>
                            </div>
                            <div class="team-row">
                                <div class="team-info">
                                    <div class="team-logo">${home.team?.abbreviation?.substring(0, 3) || '??'}</div>
                                    <div>
                                        <div class="team-name">${home.team?.shortDisplayName || home.team?.displayName || 'Home'}</div>
                                        <div class="team-record" title="Season Record: Wins - Losses">${home.records?.[0]?.summary || ''}</div>
                                    </div>
                                </div>
                                <div style="display:flex;align-items:center;gap:0.5rem">
                                    ${homeLineScores.length > 0 ? `
                                    <div style="display:flex;gap:0.25rem;font-size:0.65rem;color:var(--text-secondary)" title="Quarter/Period Scores: Points scored in Q1, Q2, Q3, Q4">
                                        ${homeLineScores.map((ls, i) => `<span style="background:var(--bg-card);padding:0.1rem 0.25rem;border-radius:3px" title="Q${i + 1}: ${ls.value || 0} pts">${ls.value || 0}</span>`).join('')}
                                    </div>
                                    ` : ''}
                                    <div class="team-score ${homeWins ? 'winner' : ''} ${isFinal && awayWins ? 'loser' : ''}" title="Final Score">${isLive || isFinal ? homeScore : ''}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Stats - Sport Specific -->
                        ${(isLive || isFinal) ? `
                        <div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid var(--border-color);font-size:0.65rem">
                            <div style="display:grid;grid-template-columns:1fr 80px 80px;gap:0.5rem;margin-bottom:0.4rem;padding-bottom:0.3rem;border-bottom:1px dashed var(--border-color)">
                                <span style="color:var(--accent-yellow);font-weight:600">üìä Stats</span>
                                <span style="text-align:center;color:var(${isFinal ? (awayWins ? '--accent-green' : '--accent-red') : '--text-secondary'});font-weight:700;font-size:0.75rem">${away.team?.abbreviation || 'AWAY'}</span>
                                <span style="text-align:center;color:var(${isFinal ? (homeWins ? '--accent-green' : '--accent-red') : '--text-secondary'});font-weight:700;font-size:0.75rem">${home.team?.abbreviation || 'HOME'}</span>
                            </div>
                            ${homeStats.length > 0 ? `
                            <div style="display:grid;grid-template-columns:1fr 80px 80px;gap:0.5rem;row-gap:0.4rem">
                                ${currentSport === 'nba' || currentSport === 'ncaa_basketball' ? `
                                    <span style="color:var(--text-secondary)">üéØ FG% (Shooting %)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'fieldGoalPct') || '-'}%</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'fieldGoalPct') || '-'}%</span>
                                    
                                    <span style="color:var(--text-secondary)">üèÄ 3P% (3-Pointers)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'threePointFieldGoalPct') || '-'}%</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'threePointFieldGoalPct') || '-'}%</span>
                                    
                                    <span style="color:var(--text-secondary)">ü™® REB (Rebounds)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'rebounds') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'rebounds') || '-'}</span>
                                    
                                    <span style="color:var(--text-secondary)">ü§ù AST (Assists)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'assists') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'assists') || '-'}</span>
                                ` : currentSport === 'nfl' ? `
                                    <span style="color:var(--text-secondary)">üèà Pass Yds (Passing)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'netPassingYards') || getStatValue(awayStats, 'totalYards') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'netPassingYards') || getStatValue(homeStats, 'totalYards') || '-'}</span>
                                    
                                    <span style="color:var(--text-secondary)">üèÉ Rush Yds (Rushing)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'rushingYards') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'rushingYards') || '-'}</span>
                                    
                                    <span style="color:var(--text-secondary)">üîÑ 1st Dwns (First Downs)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'firstDowns') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'firstDowns') || '-'}</span>
                                    
                                    <span style="color:var(--text-secondary)">‚ùå TO (Turnovers)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'turnovers') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'turnovers') || '-'}</span>
                                ` : currentSport === 'nhl' ? `
                                    <span style="color:var(--text-secondary)">üèí SOG (Shots on Goal)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'shotsOnGoal') || getStatValue(awayStats, 'shots') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'shotsOnGoal') || getStatValue(homeStats, 'shots') || '-'}</span>
                                    
                                    <span style="color:var(--text-secondary)">üß§ SV% (Save %)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'savePct') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'savePct') || '-'}</span>
                                    
                                    <span style="color:var(--text-secondary)">‚ö° PP (Power Play)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'powerPlayGoals') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'powerPlayGoals') || '-'}</span>
                                    
                                    <span style="color:var(--text-secondary)">üîÑ FO% (Faceoff %)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'faceoffWinPct') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'faceoffWinPct') || '-'}</span>
                                ` : currentSport === 'mlb' ? `
                                    <span style="color:var(--text-secondary)">‚öæ H (Hits)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'hits') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'hits') || '-'}</span>
                                    
                                    <span style="color:var(--text-secondary)">üèÉ R (Runs)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'runs') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'runs') || '-'}</span>
                                    
                                    <span style="color:var(--text-secondary)">‚ùå E (Errors)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'errors') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'errors') || '-'}</span>
                                    
                                    <span style="color:var(--text-secondary)">üí® K (Strikeouts)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'strikeouts') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'strikeouts') || '-'}</span>
                                ` : currentSport === 'soccer' ? `
                                    <span style="color:var(--text-secondary)">‚öΩ Shots</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'shotsTotal') || getStatValue(awayStats, 'shots') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'shotsTotal') || getStatValue(homeStats, 'shots') || '-'}</span>
                                    
                                    <span style="color:var(--text-secondary)">üìä Poss (Possession %)</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'possessionPct') || '-'}%</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'possessionPct') || '-'}%</span>
                                    
                                    <span style="color:var(--text-secondary)">üö© Corners</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'corners') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'corners') || '-'}</span>
                                    
                                    <span style="color:var(--text-secondary)">üü® Fouls</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(awayStats, 'foulsCommitted') || '-'}</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">${getStatValue(homeStats, 'foulsCommitted') || '-'}</span>
                                ` : `
                                    <span style="color:var(--text-secondary)">üìä Stats</span>
                                    <span style="text-align:center;background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">-</span>
                                    <span style="text-align:center;background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);padding:0.2rem;border-radius:4px;font-weight:500">-</span>
                                `}
                            </div>
                            ` : `
                            <div class="nfl-stats-placeholder" style="text-align:center;color:var(--text-secondary);padding:0.5rem;font-style:italic">
                                ${currentSport === 'nfl' ? 'üèà Loading stats...' :
                            currentSport === 'nhl' ? 'üèí Check ESPN for full game stats' :
                                currentSport === 'mlb' ? '‚öæ Stats available during live games' :
                                    currentSport === 'soccer' ? '‚öΩ Stats available during live games' :
                                        'üìä Stats available during live games'}
                            </div>
                            `}
                        </div>
                        ` : ''}
                        
                        <!-- Leaders (for live games) -->
                        ${isLive && homeLeaders.athlete ? `
                        <div style="display:flex;justify-content:space-between;margin-top:0.4rem;padding-top:0.4rem;border-top:1px dashed var(--border-color);font-size:0.65rem;color:var(--text-secondary)">
                            <span>‚≠ê ${awayLeaders.athlete?.shortName || ''}: ${awayLeaders.displayValue || ''}</span>
                            <span>‚≠ê ${homeLeaders.athlete?.shortName || ''}: ${homeLeaders.displayValue || ''}</span>
                        </div>
                        ` : ''}
                        
                        ${!isFinal ? `
                        <div class="game-prediction" style="cursor:pointer;transition:all 0.2s" 
                            onclick="trackGamePrediction('${gameId}', '${currentSport}', 'moneyline', '${predTeam}', ${predConfidence})"
                            title="${isRealPrediction ? 'Real prediction from V6 trained model' : 'Simulated prediction'} - Click to track">
                            <span>
                                ${isRealPrediction ? 'ü§ñ' : 'üéØ'} AI Pick: <strong>${predTeam}</strong>
                                ${isRealPrediction ? '<span style="font-size:0.55rem;background:var(--accent-primary);color:white;padding:0.1rem 0.3rem;border-radius:4px;margin-left:0.3rem">V6 MODEL</span>' : ''}
                            </span>
                            <span class="prediction-badge">${(predConfidence * 100).toFixed(0)}%</span>
                            <span style="font-size:0.6rem;opacity:0.6;margin-left:0.5rem">üìå</span>
                        </div>
                        ` : `
                        <div class="game-prediction" style="background:${prediction.pickHome === homeWins ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)'};border-radius:8px;padding:0.5rem">
                            <span style="display:flex;flex-direction:column;gap:0.2rem">
                                <span style="font-size:0.55rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px">
                                    üìú Past Prediction ${isRealPrediction ? '(V6 Model)' : ''}
                                </span>
                                <span>
                                    ${prediction.pickHome === homeWins ? '‚úÖ' : '‚ùå'} 
                                    Picked <strong>${predTeam}</strong> (${(predConfidence * 100).toFixed(0)}%)
                                </span>
                            </span>
                            <span style="font-weight:700;color:${prediction.pickHome === homeWins ? 'var(--accent-green)' : 'var(--accent-red)'}">
                                ${prediction.pickHome === homeWins ? 'WON' : 'LOST'}
                            </span>
                        </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        function updatePicks() {
            const picksList = document.getElementById('picks-list');
            const contractsGuide = document.getElementById('contracts-guide');
            const sportAccuracy = modelData[currentSport] || { moneyline: 0.55 };

            // Show/hide contracts guide
            if (currentPickType === 'contracts') {
                contractsGuide.style.display = 'block';
            } else {
                contractsGuide.style.display = 'none';
            }

            // Handle HISTORY tab
            if (currentPickType === 'history') {
                picksList.innerHTML = `
                    <div style="text-align:center;padding:1rem;color:var(--text-secondary)">
                        <div class="loading-spinner"></div>
                        Loading prediction history...
                    </div>
                `;

                // Load from both localStorage and CSV file, merge them
                Promise.all([
                    Promise.resolve(loadHistory()), // localStorage predictions
                    loadHistoryFromCSV() // CSV historical data
                ]).then(([localPreds, csvData]) => {
                    // Convert localStorage format to CSV format for consistency
                    const localFormatted = localPreds.map(p => ({
                        date: p.timestamp ? new Date(p.timestamp).toISOString().split('T')[0] : '',
                        sport: p.sport || '',
                        bet_type: p.betType || '',
                        pick: p.pick || '',
                        confidence: p.confidence || 0,
                        odds: p.odds || '-',
                        game_id: p.gameId || '',
                        result: p.result || 'pending',
                        actual_score: '',
                        resolved_date: p.resolvedAt ? new Date(p.resolvedAt).toISOString().split('T')[0] : '',
                        source: 'tracked' // Mark as user-tracked
                    }));

                    // Mark CSV predictions
                    const csvFormatted = csvData.predictions.map(p => ({
                        ...p,
                        source: 'historical'
                    }));

                    // Merge: localStorage first (most recent tracked), then CSV by date
                    const allPredictions = [...localFormatted, ...csvFormatted];

                    // Sort by date descending
                    allPredictions.sort((a, b) => {
                        const dateA = new Date(a.date || 0);
                        const dateB = new Date(b.date || 0);
                        return dateB - dateA;
                    });

                    // Recalculate combined stats
                    const resolved = allPredictions.filter(p => ['win', 'loss', 'push'].includes(p.result));
                    const wins = resolved.filter(p => p.result === 'win').length;
                    const losses = resolved.filter(p => p.result === 'loss').length;
                    const pushes = resolved.filter(p => p.result === 'push').length;
                    const pending = allPredictions.filter(p => p.result === 'pending').length;
                    const total = wins + losses;
                    const winRate = total > 0 ? ((wins / total) * 100).toFixed(1) : 0;

                    // Stats by sport
                    const bySport = {};
                    resolved.forEach(p => {
                        if (!bySport[p.sport]) bySport[p.sport] = { wins: 0, losses: 0 };
                        if (p.result === 'win') bySport[p.sport].wins++;
                        else if (p.result === 'loss') bySport[p.sport].losses++;
                    });
                    Object.keys(bySport).forEach(k => {
                        const s = bySport[k];
                        s.winRate = (s.wins + s.losses) > 0 ? ((s.wins / (s.wins + s.losses)) * 100).toFixed(1) : 0;
                    });

                    // Stats by bet type
                    const byType = {};
                    resolved.forEach(p => {
                        if (!byType[p.bet_type]) byType[p.bet_type] = { wins: 0, losses: 0 };
                        if (p.result === 'win') byType[p.bet_type].wins++;
                        else if (p.result === 'loss') byType[p.bet_type].losses++;
                    });
                    Object.keys(byType).forEach(k => {
                        const s = byType[k];
                        s.winRate = (s.wins + s.losses) > 0 ? ((s.wins / (s.wins + s.losses)) * 100).toFixed(1) : 0;
                    });

                    const trackedCount = localFormatted.length;

                    picksList.innerHTML = `
                        <div style="padding:1rem;background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(34,197,94,0.1));border-radius:12px;margin-bottom:1rem">
                            <h4 style="margin:0 0 1rem 0;color:var(--accent-primary)">üìä Overall Performance</h4>
                            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;text-align:center">
                                <div style="background:rgba(255,255,255,0.05);padding:0.75rem;border-radius:8px">
                                    <div style="font-size:1.3rem;font-weight:bold;color:var(--accent-green)">${winRate}%</div>
                                    <div style="font-size:0.65rem;color:var(--text-secondary)">Win Rate</div>
                                </div>
                                <div style="background:rgba(255,255,255,0.05);padding:0.75rem;border-radius:8px">
                                    <div style="font-size:1.3rem;font-weight:bold;color:var(--accent-primary)">${wins}-${losses}</div>
                                    <div style="font-size:0.65rem;color:var(--text-secondary)">W-L Record</div>
                                </div>
                                <div style="background:rgba(255,255,255,0.05);padding:0.75rem;border-radius:8px">
                                    <div style="font-size:1.3rem;font-weight:bold;color:var(--text-secondary)">${pushes}</div>
                                    <div style="font-size:0.65rem;color:var(--text-secondary)">Pushes</div>
                                </div>
                                <div style="background:rgba(255,255,255,0.05);padding:0.75rem;border-radius:8px">
                                    <div style="font-size:1.3rem;font-weight:bold;color:var(--accent-yellow)">${pending}</div>
                                    <div style="font-size:0.65rem;color:var(--text-secondary)">Pending</div>
                                </div>
                            </div>
                            
                            ${Object.keys(bySport).length > 0 ? `
                                <h5 style="margin:1rem 0 0.5rem 0;color:var(--text-secondary);font-size:0.7rem">üìä By Sport:</h5>
                                <div style="display:flex;flex-wrap:wrap;gap:0.5rem;font-size:0.65rem">
                                    ${Object.entries(bySport).map(([sport, s]) => `
                                        <span style="background:rgba(255,255,255,0.05);padding:0.25rem 0.5rem;border-radius:4px">
                                            ${sport.toUpperCase()}: <strong style="color:${s.winRate >= 55 ? 'var(--accent-green)' : 'var(--accent-red)'}">${s.wins}-${s.losses} (${s.winRate}%)</strong>
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${Object.keys(byType).length > 0 ? `
                                <h5 style="margin:0.75rem 0 0.5rem 0;color:var(--text-secondary);font-size:0.7rem">üìä By Bet Type:</h5>
                                <div style="display:flex;flex-wrap:wrap;gap:0.5rem;font-size:0.65rem">
                                    ${Object.entries(byType).map(([type, s]) => `
                                        <span style="background:rgba(255,255,255,0.05);padding:0.25rem 0.5rem;border-radius:4px">
                                            ${type}: <strong style="color:${s.winRate >= 55 ? 'var(--accent-green)' : 'var(--accent-red)'}">${s.wins}-${s.losses} (${s.winRate}%)</strong>
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        
                        
                        <h4 style="margin:0 0 0.75rem 0;color:var(--text-secondary);font-size:0.8rem">üìú All Predictions (${allPredictions.length})</h4>
                        
                        <div style="max-height:400px;overflow-y:auto;padding-right:0.5rem">
                            ${allPredictions.length === 0 ? `
                                <div style="text-align:center;padding:2rem;color:var(--text-secondary)">
                                    <div style="font-size:2rem;margin-bottom:0.5rem">üì≠</div>
                                    <div>No predictions yet</div>
                                    <div style="font-size:0.7rem;margin-top:0.5rem">Click üìå on any game card to start tracking!</div>
                                </div>
                            ` : allPredictions.map(p => `
                                <div class="pick-card" style="border-left:3px solid ${p.result === 'win' ? 'var(--accent-green)' : p.result === 'loss' ? 'var(--accent-red)' : p.result === 'push' ? 'var(--text-secondary)' : 'var(--accent-yellow)'}">
                                    <div class="pick-info" style="flex:1">
                                        <div style="font-weight:600;font-size:0.85rem">
                                            ${p.pick}
                                            ${p.source === 'tracked' ? '<span style="font-size:0.6rem;background:var(--accent-primary);padding:0.1rem 0.3rem;border-radius:3px;margin-left:0.3rem">üìå TRACKED</span>' : ''}
                                        </div>
                                        <div style="font-size:0.7rem;color:var(--text-secondary)">${(p.sport || '').toUpperCase()} ‚Ä¢ ${p.bet_type || ''} ‚Ä¢ ${p.odds || '-'}</div>
                                        <div style="font-size:0.65rem;color:var(--text-secondary)">${p.date || ''}${p.actual_score ? ` | ${p.actual_score}` : ''}</div>
                                    </div>
                                    <div style="text-align:right">
                                        <div style="font-size:0.85rem;font-weight:700;color:${p.result === 'win' ? 'var(--accent-green)' : p.result === 'loss' ? 'var(--accent-red)' : p.result === 'push' ? 'var(--text-secondary)' : 'var(--accent-yellow)'}">
                                            ${p.result === 'win' ? '‚úÖ WIN' : p.result === 'loss' ? '‚ùå LOSS' : p.result === 'push' ? '‚ÜîÔ∏è PUSH' : '‚è≥ PENDING'}
                                        </div>
                                        <div style="font-size:0.65rem;color:var(--text-secondary)">${((p.confidence || 0) * 100).toFixed(0)}% conf</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                });
                return;
            }

            const typeLabels = { moneyline: 'Moneyline', spread: 'Spread', total: 'Over/Under', contracts: 'Contract' };
            const typeKey = currentPickType === 'total' ? 'overunder' : (currentPickType === 'contracts' ? 'moneyline' : currentPickType);
            const accuracy = sportAccuracy[typeKey] || 0.55;

            const teams = ['Lakers', 'Celtics', 'Warriors', 'Heat', 'Bucks', 'Suns', '76ers', 'Nuggets'];
            const picks = [];

            for (let i = 0; i < 4; i++) {
                // Use seeded random for consistency (based on sport, type, and index)
                const seed = `${currentSport}_${currentPickType}_${i}`;
                const rand1 = seededRandom(seed + '_conf');
                const rand2 = seededRandom(seed + '_team');
                const rand3 = seededRandom(seed + '_spread');
                const rand4 = seededRandom(seed + '_ou');

                const conf = Math.min(accuracy + (rand1 * 0.08 - 0.04), 0.88);
                const ev = ((conf - 0.524) * 10).toFixed(1);
                const team = teams[Math.floor(rand2 * teams.length)];

                let pickText = team;
                let oddsText = conf > 0.55 ? '-' + (100 + Math.floor(rand1 * 50)) : '+' + (100 + Math.floor(rand1 * 80));

                if (currentPickType === 'spread') {
                    const spread = (rand3 > 0.5 ? '-' : '+') + (Math.floor(rand3 * 8) + 1) + '.5';
                    pickText = `${team} ${spread}`;
                    oddsText = '-110';
                } else if (currentPickType === 'total') {
                    const total = 200 + Math.floor(rand4 * 40) + '.5';
                    pickText = `${rand4 > 0.5 ? 'Over' : 'Under'} ${total}`;
                    oddsText = '-110';
                }

                picks.push({ team: pickText, type: typeLabels[currentPickType], conf, ev, odds: oddsText });
            }

            picks.sort((a, b) => b.conf - a.conf);

            // Different display for contracts vs regular picks
            if (currentPickType === 'contracts') {
                picksList.innerHTML = picks.map((pick, idx) => {
                    const modelPrice = pick.conf;
                    const marketSeed = seededRandom(`${currentSport}_market_${idx}`);
                    const marketPrice = Math.max(0.35, modelPrice - (0.05 + marketSeed * 0.15));
                    const edge = modelPrice - marketPrice;
                    const edgePercent = (edge * 100).toFixed(0);
                    const action = edge > 0.05 ? 'BUY YES' : (edge < -0.05 ? 'BUY NO' : 'HOLD');
                    const actionColor = action === 'BUY YES' ? 'var(--accent-green)' : (action === 'BUY NO' ? 'var(--accent-red)' : 'var(--text-secondary)');
                    const profit = ((1 - marketPrice) / marketPrice * 100).toFixed(0);
                    const hasEdge = edge >= 0.05;

                    return `
                    <div class="pick-card" style="border-left:3px solid ${actionColor};${hasEdge ? 'background:linear-gradient(90deg, rgba(16, 185, 129, 0.1), var(--bg-card));' : ''}">
                        <div class="pick-info">
                            <div class="pick-team" style="display:flex;align-items:center;gap:0.5rem">
                                ${pick.team} wins
                                ${hasEdge ? `<span style="background:linear-gradient(135deg, #f59e0b, #ef4444);color:white;font-size:0.6rem;padding:0.15rem 0.4rem;border-radius:10px;font-weight:700;animation:pulse 2s infinite">üî• +${edgePercent}% EDGE</span>` : ''}
                            </div>
                            <div style="display:flex;gap:0.5rem;font-size:0.7rem;color:var(--text-secondary);margin-top:0.25rem">
                                <span>AI: <strong style="color:var(--accent-primary)">${(modelPrice * 100).toFixed(0)}%</strong></span>
                                <span>Market: <strong>${(marketPrice * 100).toFixed(0)}%</strong></span>
                                ${hasEdge ? `<span style="color:var(--accent-green);font-weight:600">‚Üê Our model beats market!</span>` : ''}
                            </div>
                        </div>
                        <div class="pick-confidence">
                            <div style="font-size:0.85rem;font-weight:700;color:${actionColor}">${action}</div>
                            <div style="font-size:0.65rem;color:var(--text-secondary)">
                                ${action === 'BUY YES' ? `+${profit}% profit` : edge > 0 ? `+${edgePercent}¬¢ edge` : 'No edge'}
                            </div>
                        </div>
                    </div>
                    <div style="font-size:0.65rem;color:var(--text-secondary);padding:0.5rem;background:var(--bg-card);border-radius:0 0 8px 8px;margin-top:-0.5rem;margin-bottom:0.75rem">
                        ${hasEdge
                            ? `<strong style="color:var(--accent-green)">üí∞ VALUE BET:</strong> Buy $20 worth. If ${pick.team} wins ‚Üí $${(20 / marketPrice).toFixed(0)} payout (+$${((20 / marketPrice) - 20).toFixed(0)} profit!)`
                            : action === 'BUY NO'
                                ? `<strong>Strategy:</strong> Buy NO contract. The market overvalues this outcome.`
                                : `<strong>Strategy:</strong> Edge too small. Wait for better price.`
                        }
                    </div>
                `;
                }).join('');
            } else {
                picksList.innerHTML = picks.map((pick, idx) => `
                    <div class="pick-card">
                        <div class="pick-info">
                            <div class="pick-team">${pick.team}</div>
                            <div class="pick-type">${pick.type}</div>
                            <div class="pick-odds">${pick.odds}</div>
                        </div>
                        <div class="pick-confidence">
                            <div class="confidence-value">${(pick.conf * 100).toFixed(0)}%</div>
                            <div class="ev-badge">+${pick.ev} EV</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Track a prediction from UI
        function trackPrediction(sport, betType, pick, confidence, odds) {
            const gameId = `${sport}_${betType}_${pick}_${new Date().toISOString().split('T')[0]}`;
            addPrediction({
                gameId,
                sport,
                betType,
                pick,
                confidence,
                odds
            });
            alert(`üìå Tracked: ${pick}\n\nConfidence: ${(confidence * 100).toFixed(0)}%\nSport: ${sport.toUpperCase()}\nType: ${betType}`);
        }

        // Track a prediction from game card (uses actual game ID for result resolution)
        function trackGamePrediction(gameId, sport, betType, pick, confidence) {
            const history = loadHistory();
            const exists = history.find(h => h.gameId === gameId && h.betType === betType);

            if (exists) {
                // Already tracked - show notification
                const resultIcon = exists.result === 'win' ? '‚úÖ' :
                    exists.result === 'loss' ? '‚ùå' :
                        exists.result === 'push' ? '‚ÜîÔ∏è' : '‚è≥';
                alert(`Already tracked!\n\n${resultIcon} ${exists.pick}\nResult: ${exists.result.toUpperCase()}\nTracked: ${new Date(exists.timestamp).toLocaleString()}`);
                return;
            }

            addPrediction({
                gameId,
                sport,
                betType,
                pick,
                confidence,
                odds: '-' // Game cards don't have explicit odds
            });

            // Visual feedback - briefly change the element
            event.target.closest('.game-prediction').style.boxShadow = '0 0 10px var(--accent-green)';
            setTimeout(() => {
                event.target.closest('.game-prediction').style.boxShadow = '';
            }, 1000);

            // Show toast-style notification (non-blocking)
            const toast = document.createElement('div');
            toast.innerHTML = `üìå Tracked: <strong>${pick}</strong> (${(confidence * 100).toFixed(0)}%)`;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, var(--accent-primary), var(--accent-green));
                color: white;
                padding: 0.75rem 1.5rem;
                border-radius: 25px;
                font-size: 0.85rem;
                font-weight: 600;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                animation: fadeInUp 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        function generateParlays(events) {
            const parlaysContainer = document.getElementById('parlays-container');

            if (events.length < 2) {
                parlaysContainer.innerHTML = '<div class="no-games">Need 2+ games for parlays</div>';
                return;
            }

            const parlays = [
                { legs: 2, odds: '+264', risk: 'low', payout: 364 },
                { legs: 3, odds: '+595', risk: 'medium', payout: 695 },
                { legs: 4, odds: '+1228', risk: 'high', payout: 1328 }
            ];

            const parlayData = parlays.map(parlay => {
                const picks = events.slice(0, parlay.legs).map(e => {
                    const comp = e.competitions?.[0];
                    const home = comp?.competitors?.find(c => c.homeAway === 'home');
                    const away = comp?.competitors?.find(c => c.homeAway === 'away');

                    const status = e.status?.type?.name || '';
                    const isFinal = status.includes('FINAL');
                    const homeScore = parseInt(home?.score) || 0;
                    const awayScore = parseInt(away?.score) || 0;
                    const homeWon = homeScore > awayScore;

                    // Use real prediction or cache
                    const gameId = e.id || `${home?.team?.id}_${away?.team?.id}`;
                    const realPred = getRealPrediction(gameId, currentSport);
                    let pick, conf, pickHome;

                    if (realPred && realPred.predictions) {
                        const ml = realPred.predictions.moneyline;
                        pick = ml.pick;
                        conf = (ml.confidence * 100).toFixed(0);
                        pickHome = ml.pick_home;
                    } else if (realPred) {
                        pick = realPred.pick;
                        conf = (realPred.confidence * 100).toFixed(0);
                        pickHome = realPred.pick_home;
                    } else {
                        const cached = predictionCache[gameId];
                        pick = cached ? cached.team : (home?.team?.abbreviation || '???');
                        conf = cached ? (cached.confidence * 100).toFixed(0) : '60';
                        pickHome = cached ? cached.pickHome : true;
                    }

                    // Determine result for finished games
                    let result = null;
                    if (isFinal) {
                        result = (pickHome === homeWon) ? 'hit' : 'miss';
                    }

                    return {
                        team: pick, conf, gameId, isFinal, result, pickHome,
                        homeTeam: home?.team?.abbreviation || '',
                        awayTeam: away?.team?.abbreviation || '',
                        homeScore, awayScore
                    };
                });

                const combinedConf = picks.reduce((acc, p) => acc * (parseInt(p.conf) / 100), 1);
                const parlayId = `parlay_${currentSport}_${parlay.legs}_${picks.map(p => p.gameId).join('_')}`;
                const parlayPick = `${parlay.legs}-Leg: ${picks.map(p => p.team + ' ML').join(' + ')}`;

                // Calculate parlay result
                const finishedPicks = picks.filter(p => p.isFinal);
                const hits = finishedPicks.filter(p => p.result === 'hit').length;
                const misses = finishedPicks.filter(p => p.result === 'miss').length;
                const allFinished = finishedPicks.length === picks.length;
                const parlayHit = allFinished && misses === 0;
                const parlayBusted = misses > 0;

                addPrediction({
                    gameId: parlayId, sport: currentSport, betType: 'parlay',
                    pick: parlayPick, confidence: combinedConf, odds: parlay.odds,
                    parlayLegs: picks.map(p => ({ gameId: p.gameId, team: p.team }))
                });

                return { parlay, picks, combinedConf, parlayId, hits, misses, finishedCount: finishedPicks.length, parlayHit, parlayBusted };
            });

            parlaysContainer.innerHTML = parlayData.map(({ parlay, picks, hits, misses, finishedCount, parlayHit, parlayBusted }) => {
                let resultBadge = '';
                if (finishedCount === picks.length && finishedCount > 0) {
                    resultBadge = parlayHit
                        ? `<div style="text-align:center;margin:0.3rem 0"><span style="background:var(--accent-green);color:white;padding:0.2rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:700">üí∞ PARLAY HIT!</span></div>`
                        : `<div style="text-align:center;margin:0.3rem 0"><span style="background:var(--accent-red);color:white;padding:0.2rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:700">‚ùå BUSTED</span></div>`;
                } else if (finishedCount > 0) {
                    resultBadge = `<div style="text-align:center;margin:0.3rem 0"><span style="background:var(--bg-tertiary);color:var(--text-secondary);padding:0.2rem 0.5rem;border-radius:4px;font-size:0.65rem">‚úì${hits} ‚úó${misses} of ${picks.length}</span></div>`;
                }

                const cardStyle = parlayHit ? 'border:2px solid var(--accent-green);background:rgba(16,185,129,0.05)'
                    : parlayBusted ? 'border:2px solid var(--accent-red);background:rgba(239,68,68,0.05);opacity:0.8' : '';

                return `
                    <div class="parlay-card" style="${cardStyle}">
                        <div class="parlay-header">
                            <span class="parlay-legs">${parlay.legs}-Leg Parlay</span>
                            <span class="parlay-odds">${parlay.odds}</span>
                        </div>
                        ${resultBadge}
                        <div class="parlay-picks">
                            ${picks.map(p => {
                    let style = '', icon = '';
                    if (p.isFinal) {
                        if (p.result === 'hit') {
                            style = 'background:rgba(${homeWins ? "16,185,129" : "239,68,68"},0.15);border-left:3px solid var(--accent-green);padding-left:0.4rem';
                            icon = '<span style="color:var(--accent-green);font-weight:700">‚úì</span>';
                        } else {
                            style = 'background:rgba(${awayWins ? "16,185,129" : "239,68,68"},0.15);border-left:3px solid var(--accent-red);padding-left:0.4rem';
                            icon = '<span style="color:var(--accent-red);font-weight:700">‚úó</span>';
                        }
                    }
                    return `
                                <div class="parlay-pick" style="${style};border-radius:4px;margin:0.15rem 0">
                                    <span style="display:flex;align-items:center;gap:0.3rem">
                                        ${icon}<span>${p.team}</span>
                                        ${p.isFinal ? `<span style="font-size:0.55rem;color:var(--text-secondary)">(${p.awayTeam} ${p.awayScore}-${p.homeScore} ${p.homeTeam})</span>` : ''}
                                    </span>
                                    <span>${p.conf}%</span>
                                </div>`;
                }).join('')}
                        </div>
                        <div class="parlay-footer">
                            <span class="risk-badge risk-${parlay.risk}">${parlay.risk.toUpperCase()} RISK</span>
                            <span class="parlay-payout">${parlayBusted ? '‚ùå $0' : `$100 ‚Üí $${parlay.payout}`}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateLiveCount(events) {
            const liveCount = events.filter(e => e.status?.type?.name?.includes('IN_PROGRESS')).length;

            const activeTab = document.querySelector('.nav-tab.active');
            const existingBadge = activeTab.querySelector('.live-badge');
            if (existingBadge) existingBadge.remove();

            if (liveCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'live-badge';
                badge.textContent = liveCount + ' LIVE';
                activeTab.appendChild(badge);
            }
        }

        function updateModelStats() {
            // Calculate average accuracy
            let totalAcc = 0, count = 0;
            Object.values(modelData).forEach(sport => {
                Object.values(sport).forEach(acc => {
                    totalAcc += acc;
                    count++;
                });
            });
            const avgAcc = count > 0 ? totalAcc / count : 0.55;
            const roi = ((avgAcc - 0.524) / 0.524 * 100).toFixed(1);

            document.getElementById('accuracy').textContent = (avgAcc * 100).toFixed(0) + '%';
            document.getElementById('roi').textContent = '+' + roi + '%';
            document.getElementById('stat-accuracy').textContent = (avgAcc * 100).toFixed(1) + '%';
            document.getElementById('stat-roi').textContent = '+' + roi + '%';
        }

        function refreshGames() { loadGames(); }

        // Auto-refresh every 30 seconds
        setInterval(loadGames, 30000);

        // Initial load - first load real predictions, then games
        async function init() {
            await loadRealPredictions();
            loadGames();
            updatePicks();
            updateModelStats();
        }
        init();
    </script>
</body>

</html>